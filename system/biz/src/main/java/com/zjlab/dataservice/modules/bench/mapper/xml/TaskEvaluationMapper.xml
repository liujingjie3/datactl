<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zjlab.dataservice.modules.bench.mapper.TaskEvaluationMapper">

    <select id="selectByModelAndCapability" resultType="com.zjlab.dataservice.modules.bench.model.entity.TaskEvaluation">
        SELECT
        bte.id,
        bte.model_id,
        bte.task_name,
        bt.capability_id,
        bte.task_identifier,
        bte.evaluation_metric,
        bte.dataset_count,
        bte.last_updated,
        bte.harmonic_mean_score
        FROM
        bench_task_evaluation bte
        JOIN
        bench_tasks bt ON bte.task_identifier = bt.task_identifier
        WHERE
        bt.capability_id = #{request.capabilityId}
        <if test="request.modelId != null and request.modelId != ''">
            AND bte.model_id = #{request.modelId}
        </if>

        <!-- 排序逻辑 -->
        <choose>
            <when test="request.orderByField != null and request.orderByField != ''">
                <!-- 动态限制排序字段，防止 SQL 注入 -->
                ORDER BY
                <choose>
                    <when test="request.orderByField == 'task_identifier'">
                        bte.task_name
                    </when>
                    <when test="request.orderByField == 'harmonic_mean_score'">
                        bte.harmonic_mean_score
                    </when>
                    <otherwise>
                        bte.last_updated
                    </otherwise>
                </choose>

                <!-- 根据 orderByType 选择排序方式 -->
                <if test="request.orderByType != null and request.orderByType == 'asc'">
                    ASC
                </if>
                <if test="request.orderByType == null or request.orderByType == 'desc'">
                    DESC
                </if>
            </when>
            <otherwise>
                ORDER BY bte.harmonic_mean_score DESC
            </otherwise>
        </choose>
    </select>

</mapper>