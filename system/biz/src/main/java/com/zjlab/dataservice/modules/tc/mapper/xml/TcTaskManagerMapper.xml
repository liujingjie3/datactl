<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zjlab.dataservice.modules.tc.mapper.TcTaskManagerMapper">

    <sql id="selectFields">
        t.id AS taskId,
        t.task_name AS taskName,
        t.task_code AS taskCode,
        t.template_id AS templateId,
        tt.template_name AS templateName,
        t.satellites AS satellites,
        t.create_time AS createTime,
        t.status AS status
    </sql>

    <sql id="whereCommon">
        t.del_flag = 0
        <if test="query.q != null and query.q != ''">
            AND (t.task_name LIKE CONCAT('%', #{query.q}, '%') OR t.task_code LIKE CONCAT('%', #{query.q}, '%'))
        </if>
        <if test="query.status != null">
            AND t.status = #{query.status}
        </if>
        <if test="query.templateId != null">
            AND t.template_id = #{query.templateId}
        </if>
        <if test="query.startTimeFrom != null">
            AND t.create_time &gt;= #{query.startTimeFrom}
        </if>
    </sql>

    <select id="selectTaskList" resultType="com.zjlab.dataservice.modules.tc.model.vo.TaskManagerListItemVO">
        SELECT
        <include refid="selectFields"/>
        FROM (
            SELECT t.*
            FROM tc_task t
            <if test="query.tab == 'todo' or query.tab == 'handled'">
                JOIN tc_task_work_item wi ON wi.task_id = t.id
            </if>
            WHERE
            <include refid="whereCommon"/>
            <if test="query.tab == 'startedByMe'">
                AND t.create_by = #{query.userId}
            </if>
            <if test="query.tab == 'todo'">
                AND wi.del_flag = 0 AND wi.assignee_id = #{query.userId} AND wi.phase_status IN (0,1)
            </if>
            <if test="query.tab == 'handled'">
                AND wi.del_flag = 0 AND wi.assignee_id = #{query.userId}
                AND wi.phase_status IN (2,4,5)
            </if>
            ORDER BY t.create_time DESC
            LIMIT #{query.offset}, #{query.pageSize}
        ) t
        LEFT JOIN tc_todo_template tt ON tt.template_id = t.template_id
    </select>

    <select id="countTaskList" resultType="long">
        SELECT
        <choose>
            <when test="query.tab == 'todo' or query.tab == 'handled'">
                COUNT(DISTINCT t.id)
            </when>
            <otherwise>
                COUNT(1)
            </otherwise>
        </choose>
        FROM tc_task t
        <if test="query.tab == 'todo' or query.tab == 'handled'">
            JOIN tc_task_work_item wi ON wi.task_id = t.id
        </if>
        WHERE
        <include refid="whereCommon"/>
        <if test="query.tab == 'startedByMe'">
            AND t.create_by = #{query.userId}
        </if>
        <if test="query.tab == 'todo'">
            AND wi.del_flag = 0 AND wi.assignee_id = #{query.userId} AND wi.phase_status IN (0,1)
        </if>
        <if test="query.tab == 'handled'">
            AND wi.del_flag = 0 AND wi.assignee_id = #{query.userId}
            AND wi.phase_status IN (2,4,5)
        </if>
    </select>

    <select id="selectCurrentNodes" resultType="com.zjlab.dataservice.modules.tc.model.dto.CurrentNodeRow">
        SELECT
            ni.task_id AS taskId,
            ni.id AS nodeInstId,
            ninfo.name AS nodeName,
            ni.handler_role_ids AS handlerRoleIds
        FROM tc_task_node_inst ni
        JOIN tc_node_info ninfo ON ninfo.id = ni.node_id
        WHERE ni.del_flag = 0 AND ni.status = 1
          AND ni.task_id IN
            <foreach collection="taskIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        ORDER BY ni.task_id, ni.order_no, ni.id
    </select>

    <select id="selectTaskStatus" resultType="int">
        SELECT status FROM tc_task WHERE id = #{taskId} AND del_flag = 0 FOR UPDATE
    </select>

    <select id="countDoneNodeInst" resultType="long">
        SELECT COUNT(*) FROM tc_task_node_inst
        WHERE task_id = #{taskId} AND del_flag = 0 AND status = 2 FOR UPDATE
    </select>

    <update id="updateTaskCancel">
        UPDATE tc_task
        SET status = 3,
            update_by = #{userId},
            update_time = NOW()
        WHERE id = #{taskId} AND del_flag = 0
    </update>

    <update id="updateNodeInstCancel">
        UPDATE tc_task_node_inst
        SET status = 3,
            update_by = #{userId},
            update_time = NOW()
        WHERE task_id = #{taskId} AND del_flag = 0 AND status IN (0,1)
    </update>

    <update id="updateWorkItemCancel">
        UPDATE tc_task_work_item
        SET phase_status = 3,
            update_by = #{userId},
            update_time = NOW()
        WHERE task_id = #{taskId} AND del_flag = 0 AND phase_status IN (0,1)
    </update>

    <select id="selectTaskForEdit" resultType="com.zjlab.dataservice.modules.tc.model.dto.TaskManagerEditInfo">
        SELECT status, create_by AS createBy, template_id AS templateId, result_display_needed AS resultDisplayNeeded
        FROM tc_task
        WHERE id = #{taskId} AND del_flag = 0 FOR UPDATE
    </select>

    <update id="updateTask">
        UPDATE tc_task
        SET task_name = #{dto.taskName},
            task_requirement = #{dto.taskRequirement},
            need_imaging = #{dto.needImaging},
            imaging_area = #{dto.imagingArea},
            result_display_needed = #{dto.resultDisplayNeeded},
            update_by = #{userId},
            update_time = NOW()
        WHERE id = #{dto.taskId} AND del_flag = 0
    </update>

    <select id="selectEndNodeInstIds" resultType="long">
        SELECT id FROM tc_task_node_inst
        WHERE task_id = #{taskId} AND del_flag = 0 AND JSON_LENGTH(next_node_ids) = 0
    </select>

    <insert id="insertViewNodeInst">
        INSERT INTO tc_task_node_inst(
            task_id, template_id, node_id, prev_node_ids, next_node_ids,
            arrived_count, handler_role_ids, order_no, status, max_duration,
            create_by, create_time, update_by, update_time
        ) VALUES (
            #{taskId}, #{templateId}, #{nodeId}, #{prevNodeIds}, '[]',
            0, #{handlerRoleIds}, NULL, 0, NULL,
            #{userId}, NOW(), #{userId}, NOW()
        )
    </insert>

    <select id="selectLastInsertId" resultType="long">
        SELECT LAST_INSERT_ID()
    </select>

    <update id="appendViewNodeToEndNodes">
        UPDATE tc_task_node_inst
        SET next_node_ids = JSON_ARRAY_APPEND(next_node_ids, '$', #{nodeInstId}),
            update_by = #{userId},
            update_time = NOW()
        WHERE id IN
        <foreach collection="endInstIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <select id="selectViewNodeInstId" resultType="long">
        SELECT id FROM tc_task_node_inst
        WHERE task_id = #{taskId} AND node_id = #{nodeId} AND del_flag = 0
    </select>

    <update id="deleteNodeInst">
        UPDATE tc_task_node_inst
        SET del_flag = 1,
            update_by = #{userId},
            update_time = NOW()
        WHERE id = #{nodeInstId} AND del_flag = 0
    </update>

    <update id="clearEndNodeNext">
        UPDATE tc_task_node_inst
        SET next_node_ids = '[]',
            update_by = #{userId},
            update_time = NOW()
        WHERE task_id = #{taskId} AND del_flag = 0
          AND JSON_CONTAINS(next_node_ids, CAST(#{nodeInstId} AS JSON), '$')
    </update>

    <select id="selectUserIdsByRoleIds" resultType="string">
        SELECT DISTINCT ur.user_id
        FROM sys_user_role ur
        WHERE ur.role_id IN
        <foreach collection="roleIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <insert id="insertWorkItem">
        INSERT INTO tc_task_work_item(
            task_id, node_inst_id, assignee_id, phase_status,
            create_by, create_time, update_by, update_time
        ) VALUES (
            #{taskId}, #{nodeInstId}, #{assigneeId}, #{phaseStatus},
            #{userId}, NOW(), #{userId}, NOW()
        )
    </insert>

    <update id="deleteWorkItemsByNodeInst">
        UPDATE tc_task_work_item
        SET del_flag = 1,
            update_by = #{userId},
            update_time = NOW()
        WHERE node_inst_id = #{nodeInstId} AND del_flag = 0
    </update>

</mapper>
