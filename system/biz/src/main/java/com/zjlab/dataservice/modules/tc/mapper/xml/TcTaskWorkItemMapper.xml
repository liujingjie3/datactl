<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zjlab.dataservice.modules.tc.mapper.TcTaskWorkItemMapper">

    <insert id="insertWorkItem">
        INSERT INTO tc_task_work_item(
            task_id, node_inst_id, assignee_id, phase_status,
            create_by, create_time, update_by, update_time
        ) VALUES (
            #{taskId}, #{nodeInstId}, #{assigneeId}, #{phaseStatus},
            #{userId}, NOW(), #{userId}, NOW()
        )
    </insert>

    <update id="deleteWorkItemsByNodeInst">
        UPDATE tc_task_work_item
        SET del_flag = 1,
            update_by = #{userId},
            update_time = NOW()
        WHERE node_inst_id = #{nodeInstId} AND del_flag = 0
    </update>

    <update id="updateWorkItemCancel">
        UPDATE tc_task_work_item
        SET phase_status = 3,
            update_by = #{userId},
            update_time = NOW()
        WHERE task_id = #{taskId} AND del_flag = 0 AND phase_status IN (0,1)
    </update>

    <update id="updateMyWorkItem">
        UPDATE tc_task_work_item
        SET phase_status = 2,
            update_by = #{userId},
            update_time = NOW()
        WHERE task_id = #{taskId} AND node_inst_id = #{nodeInstId} AND assignee_id = #{userId} AND del_flag = 0
    </update>

    <update id="updateOtherWorkItem">
        UPDATE tc_task_work_item
        SET phase_status = 4,
            update_by = #{userId},
            update_time = NOW()
        WHERE task_id = #{taskId} AND node_inst_id = #{nodeInstId} AND assignee_id &lt;&gt; #{userId} AND del_flag = 0 AND phase_status IN (0,1)
    </update>

    <update id="updateWorkItemAbort">
        UPDATE tc_task_work_item
        SET phase_status = 5,
            update_by = #{userId},
            update_time = NOW()
        WHERE task_id = #{taskId} AND del_flag = 0 AND phase_status IN (0,1)
    </update>

    <select id="countActiveWorkItem" resultType="long">
        SELECT COUNT(*) FROM tc_task_work_item
        WHERE task_id = #{taskId}
          AND node_inst_id = #{nodeInstId}
          AND assignee_id = #{assigneeId}
          AND del_flag = 0 AND phase_status IN (0,1)
    </select>

    <update id="activateWorkItem">
        UPDATE tc_task_work_item
        SET phase_status = 1,
            update_by = #{userId},
            update_time = NOW()
        WHERE task_id = #{taskId}
          AND node_inst_id = #{nodeInstId}
          AND phase_status = 0 AND del_flag = 0
    </update>

    <select id="selectAssigneeIds" resultType="string">
        SELECT assignee_id FROM tc_task_work_item
        WHERE task_id = #{taskId}
          AND node_inst_id = #{nodeInstId}
          AND del_flag = 0
    </select>

</mapper>
